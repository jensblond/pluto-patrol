<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Pluto Patrol</title>
        <script src="phaser.js"></script>
    </head>
    <body>

    <script type="text/javascript">

    window.onload = function() {

        var cursors;
        var tank;
        var ground;
        var baseSpeed = 100;
        var shits;
        var anim;
        var total = 0;
        var bullets;
        var fireRate = 100;
        var nextFire = 0;
        var bounds;
        var dummy;
        var groundCollision;
        var fireKey;

        var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update, render: render });

        function preload () {
            // Asset preloading
            game.load.spritesheet('tank', 'img/tank.png', 160, 76, 2);
            // game.load.image('ufo','img/ufo.png');
            // game.load.image('ufo2','img/ufo2.png');
            // game.load.image('ufo3','img/ufo3.png');
            game.load.image('bullet', 'img/bullet.png');
            // game.load.image('pittfall', 'img/pittfall.png');
            // game.load.image('sky', 'img/sky.png');
            // game.load.image('mountain', 'img/mountain.png');
            game.load.image('shit', 'img/shit.png');
            game.load.image('ground', 'img/ground.png');

            game.load.audio('explosion_tank', 'sounds/explosion0.wav');
            game.load.audio('explosion_shit', 'sounds/explosion1.wav');
            game.load.audio('laser_tank', 'sounds/laser.wav');
        }

        function render() {
            // game.debug.body(tank);
            // game.debug.body(groundCollision);
            // game.debug.body(shits);
            // game.debug.cameraInfo(game.camera, 32, 32);
            // game.debug.text('Active Bullets: ' + bullets.countLiving() + ' / ' + bullets.total, 32, 32);
            // game.debug.body(boundsLeft);
            // game.debug.body(boundsRight);
        }

        function create () {
            game.physics.startSystem(Phaser.Physics.ARCADE);
            game.world.setBounds(0, 0, 20000, game.height);

            ground = game.add.tileSprite(0, game.height - 64, game.stage.bounds.width, game.cache.getImage('ground').height, 'ground');

            tank = game.add.sprite(10, ground.y - (ground.height + 100), 'tank', 0);
            tank.animations.add('drive');
            
            game.physics.arcade.enable(ground);
            ground.body.immovable = true;
            ground.body.velocity.x = baseSpeed;

            groundCollision = game.add.sprite(0, game.height - 64);
            groundCollision.scale.x = game.width;
            game.physics.arcade.enable(groundCollision);
            groundCollision.body.immovable = true;

            game.physics.arcade.enable(tank);

            tank.body.bounce.y = 0.2;
            tank.body.gravity.y = 300;
            tank.body.collideWorldBounds = true;

            // Shit
            shits = game.add.group();
            game.physics.arcade.enable(shits);
            shits.enableBody = true;
    
            // Bullets
            bullets = game.add.group();
            game.physics.arcade.enable(bullets);
            bullets.enableBody = true;
            bullets.createMultiple(200, 'bullet');
            bullets.setAll('checkWorldBounds', true);
            bullets.setAll('outOfBoundsKill', true);

            // Make the tank collide with the screen borders
            bounds = game.add.group();
            game.physics.arcade.enable(bounds);

            boundsLeft = game.add.sprite(0, 0);
            boundsLeft.x = -boundsLeft.width;
            boundsLeft.scale.y = game.height;
            game.physics.arcade.enable(boundsLeft);
            boundsLeft.body.velocity.x = baseSpeed
            boundsLeft.body.immovable = true;

            boundsRight = game.add.sprite(game.width/2, 0);
            boundsRight.scale.y = game.height;
            game.physics.arcade.enable(boundsRight);
            boundsRight.body.velocity.x = baseSpeed
            boundsRight.body.immovable = true;

            bounds.add(boundsRight);
            bounds.add(boundsLeft);
            bounds.enableBody = true;

            // The camera will follow this dummy object
            dummy = game.add.sprite(game.width/2, game.height/2);
            game.physics.arcade.enable(dummy);
            dummy.body.velocity.x = baseSpeed;
            game.camera.follow(dummy);

            cursors = game.input.keyboard.createCursorKeys();
            add_shit();

            // sounds
            exposionTankSound = game.add.audio('explosion_tank');
            exposionShitSound = game.add.audio('explosion_shit');
            tankLaserSound = game.add.audio('laser_tank');

            fireKey = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);
        }

        function add_shit() {
            shit = game.add.sprite(500 , ground.y - game.cache.getImage('shit').height ,'shit');
            shits.add(shit);
            shit.body.immovable = true;
            next_shit = parseInt(Math.random() * 100) + 100;
        }

        function collision (tank_collide, shit_collide) {
            tank.kill();
            exposionTankSound.play();
            console.log("Boom");
        }

        function fire() {
            if (game.time.now > nextFire && bullets.countDead() > 0) {
                nextFire = game.time.now + fireRate;

                var bulletX = bullets.getFirstDead();

                bulletX.reset(tank.x + tank.width - 18, tank.y+48);

                game.physics.arcade.moveToXY(bulletX, tank.x+game.width, bulletX.y, 600, 500);

                var bulletY = bullets.getFirstDead();

                bulletY.reset(tank.x + tank.width - 18, tank.y+18);

                game.physics.arcade.moveToXY(bulletY, bulletY.x, 0, 600, 500);

                tankLaserSound.play();

        //          bullet.x +=10;
            }
        }

        function shitBoom(bullet, shit) {
            shit.kill();
            exposionShitSound.play();
            bullet.kill();
        }

    function update() {
        tank.animations.play('drive',6);


        if (tank.alive) {
            ground.tilePosition.x -= dummy.deltaX;

            // Fire the bullets
            if (fireKey.isDown) {
                    fire();
            }            
        } else {
            for (var i = bounds.length - 1; i >= 0; i--) {
                bounds.getAt(i).body.velocity.x = 0;
            }
            dummy.body.velocity.x = 0;
            ground.body.velocity.x = 0;
        }
        
        game.physics.arcade.collide(tank, groundCollision);
        game.physics.arcade.collide(tank, bounds);
        game.physics.arcade.collide(tank, shits, collision);
        game.physics.arcade.collide(bullets, shits, shitBoom);

        if (tank.body.touching.down) {
            tank.body.velocity.x = 100;
        }

        if (cursors.right.isDown && tank.body.touching.down) {
            tank.body.velocity.x += 100;
        }

        if (cursors.left.isDown && tank.body.touching.down) {
            tank.body.velocity.x -= 100;
            tank.animations.stop();
        }

        //  Allow the tank to jump if they are touching the ground.
        if (cursors.up.isDown && tank.body.touching.down) {
            tank.body.velocity.y = -270;
        }
    }

    };

    </script>

    </body>
</html>
